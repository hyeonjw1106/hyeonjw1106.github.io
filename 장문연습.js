const textData = {
  "애국가": [
    "애국가",
    "동해물과 백두산이 마르고 닳도록",
    "하느님이 보우하사 우리나라 만세",
    "무궁화 삼천리 화려 강산",
    "대한 사람 대한으로 길이 보전하세",
    "남산 위에 저 소나무 철갑을 두른듯",
    "바람 서리 불변함은 우리 기상일세",
    "무궁화 삼천리 화려 강산",
    "대한 사람 대한으로 길이 보전하세",
    "가을 하늘 공활한데 높고 구름 없이",
    "밝은 달은 우리 가슴 일편단심일세",
    "무궁화 삼천리 화려 강산",
    "대한 사람 대한으로 길이 보전하세",
    "이 기상과 이 맘으로 충성을 다하여",
    "괴로우나 즐거우나 나라 사랑하세",
    "무궁화 삼천리 화려 강산",
    "대한 사람 대한으로 길이 보전하세."
  ],
  "별 헤는 밤": [
    "별 헤는 밤",
    "윤동주",
    "계절이 지나가는 하늘에는",
    "가을로 가득 차 있습니다",
    "나는 아무 걱정도 없이",
    "가을 속의 별들을 다 헤일 듯합니다",
    "가슴속에 하나둘 새겨지는 별을",
    "이제 다 못 헤는 것은 쉬이 아침이 오는 까닭이요,",
    "내일 밤이 남은 까닭이요, 아직 나의 청춘이 다하지 않은 까닭입니다.",
    "별 하나에 추억과 별 하나에 사랑과",
    "별 하나에 쓸쓸함과 별 하나에 동경과",
    "별 하나에 시와 별 하나에 어머니, 어머니,",
    "어머님, 나는 별 하나에 아름다운 말 한마디씩 불러 봅니다.",
    "소학교 때 책상을 같이 했던 아이들의 이름과, 패, 경, 옥, 이런 이국 소녀들의 이름과,",
    "벌써 아기 어머니 된 계집애들의 이름과, 가난한 이웃 사람들의 이름과,",
    "비둘기, 강아지, 토끼, 노새, 노루, '프랑시스 잠', '라이너 마리아 릴케'",
    "이런 시인의 이름을 불러 봅니다.",
    "이네들은 너무나 멀리 있습니다. 별이 아스라이 멀듯이.",
    "어머님, 그리고 당신은 멀리 북간도에 계십니다",
    "나는 무엇인지 그리워 이 많은 별빛이 내린 언덕 위에",
    "내 이름자를 써보고 흙으로 덮어 버리었습니다.",
    "딴은 밤을 새워 우는 벌레는 부끄러운 이름을 슬퍼하는 까닭입니다.",
    "그러나 겨울이 지나고 나의 별에도 봄이 오면",
    "무덤 위에 파란 잔디가 피어나듯이",
    "내 이름자 묻힌 언덕 위에도 자랑처럼 풀이 무성할 거외다."
  ],
  "님의 침묵": [
    "님의 침묵",
    "한용운",
    "님은 갔습니다",
    "아 아 사랑하는 나의 님은 갔습니다",
    "푸른 산빛을 깨치고 단풍나무 숲을 향하여",
    "난 작은 길을 차마 떨치고 갔습니다.",
    "황금의 꽃갈이 굳고 빛나던 옛 맹세는 차디찬 티끌이 되어서",
    "한숨의 미풍이 되어 날아갔습니다. 날카로운 첫 키스의 추억은",
    "나의 운명의 지침을 돌려놓고 뒷걸음쳐서 사라졌습니다.",
    "나는 향기로운 님의 말소리에 귀먹고, 꽃다운 님의 얼굴에 눈멀었습니다.",
    "사랑도 사람의 일이라 만날 때에 미리 떠날 것을 염려하고 경계하지",
    "아니한 것은 아니지만, 이별은 뜻밖의 일이 되고 놀란 가슴은",
    "새로이 슬픔에 터집니다.",
    "그러나 이별을 쓸데없는 눈물의 원천을 만들고 마는 것은",
    "스스로 사랑을 깨치는 것인 줄 아는 까닭에 걷잡을 수 없는",
    "슬픔의 힘을 옮겨서 새 희망의 정수박이에 들이부었습니다.",
    "우리는 만날 때에 떠날 것은 염려하는 것과 같이",
    "떠날 때에 다시 만날 것은 믿습니다.",
    "아아, 님은 갔지마는 나는 님을 보내지 아니하였습니다.",
    "제 곡조를 못이기는 사랑의 노래는 님의 침묵을 휩싸고 돕니다."
  ],
  "바람의 사생활": [
    "바람의 사생활",
    "이병률",
    "가을은 차고 물도 차다",
    "둥굴고 가혹한 방 여기저기를 떠돌던 내 그림자가",
    "어기적어기적 나뭇잎을 뜯어먹고 한숨을 내쉬었던 순간",
    "그 순간 사내라는 말도 생겼을까 저 먼 옛날 오래전 오늘",
    "사내라는 말이 솟구친 자리에 서럽고 끝이 무딘 고드름은 매달렸을까",
    "슬픔으로 빚은 품이며 바람같다 할 같다",
    "그러지 않으면 이리 숨이 찰 수 있나",
    "먼 기차소리라고도 하기도 그렇고",
    "비의 냄새라고 하기엔 더 그렇고",
    "계집이란 말은 안팍이 잡히는데",
    "그 무엇이 대신해줄 것 같지 않은",
    "사내라는 말은 서럽고 차가와",
    "도망가려 버둥거리는 정처를 붙드는 순간 내 손에 뜨거운 피가 밸 것 같다",
    "처음엔 햇빛이 생겼으나 눈빛이 생겼을 것이고",
    "가슴이 생겼으나 심장이 생겨났을 것이다",
    "한 사내가 두 사내가 되고 열 사내를 스물, 백, 천의 사내로 번지게 하고",
    "불살랐던 바람의 습관들",
    "되돌아보면 그 바람을 받아먹고 내 나무의 가지에 피를 돌게 하여",
    "무심히 당신 앞을 수천 년 흘렀을 것이다",
    "그 바람이 아직 찬란히 끝나지 않은 것이다"
  ],
  "찬란": [
    "찬란",
    "이병률",
    "겨우내 아무 일 없던 화분에서 잎이 나니 찬란하다",
    "흙이 감정을 참지 못하니 찬란하다",
    "감자에서 난 싹을 화분에 옮겨 심는 것도",
    "손끝에서 종이 넘기는 소리를 듣는 것도",
    "오래도록 내 뼈에 방들이 우는소리 재우는 일도 찬란이다",
    "살고자 하는 일이 찬란이었으므로 의자에 먼지 앉는 일은 더 찬란이리",
    "찬란하지 않으면 모두 뒤쳐지고 광장에서 멀어지리",
    "지난밤 남쪽의 바다를 생각하던 중에 등을 켜려다 전구가 나가고",
    "검푸른 어둠이 굽이쳤으나 생각만으로 겨울을 불렀으니 찬란이다",
    "실로 이기고 지는 깐깐한 생명들이 뿌리까지 피곤한 것도",
    "햇빛의 가랑이 사이로 북회귀선과 남회귀선이 만나는 것도",
    "무시무시한 찬란이다",
    "찬란이 아니면 다 그만이다. 죽음 앞에서 모든 목숨은",
    "찬란의 끝에서 걸쇠를 건져 올려 마음에 걸 것이니",
    "지금껏으로도 많이 살았다 싶은 것은 찬란을 배웠기 때문",
    "그러고도 겨우 일 년을 조금 넘게 살았다고 기분이 드는 것도",
    "다 찬란이다."
  ]
};

// --- 변수 초기화 ---
let selectedSentences = [];
let currentLetter = '';
let nextLetter = '';
let startTime = null;
let totalKeystrokes = 0;
let accuracyPercent = 100;
let typedCount = 0;
let intervalTimer = null;
let processing = false;

// --- DOM 요소들 ---
const currentDiv = document.getElementById('current');
const nextDiv = document.getElementById('next');
const inputField = document.getElementById('input');
const timeDisplay = document.getElementById('timeDisplay');
const typingSpeedDisplay = document.getElementById('typingSpeed');
const speedBar = document.getElementById('speedBar');
const remainingCountDiv = document.getElementById('remainingCount');
const modal = document.getElementById('resultModal');
const modalRetryBtn = document.getElementById('modalRetryBtn');
const resultTime = document.getElementById('resultTime');
const resultSpeed = document.getElementById('resultSpeed');
const resultAccuracy = document.getElementById('resultAccuracy');
const countdownDiv = document.getElementById('countdown');
const typingArea = document.getElementById('typingArea');
const inputArea = document.getElementById('inputArea');
const accuracyDisplay = document.getElementById('accuracyDisplay');
const accuracyBar = document.getElementById('accuracyBar');
const keyboardDiv = document.getElementById('keyboard');
const textSelect = document.getElementById('textSelect');
const backBtn = document.getElementById('backBtn');
const modalBackBtn = document.getElementById('modalBackBtn');

// --- 키보드 배열 ---
const keyboardRows = [
  ['ㅂ', 'ㅈ', 'ㄷ', 'ㄱ', 'ㅅ', 'ㅛ', 'ㅕ', 'ㅑ', 'ㅐ', 'ㅔ'],
  ['ㅁ', 'ㄴ', 'ㅇ', 'ㄹ', 'ㅎ', 'ㅗ', 'ㅓ', 'ㅏ', 'ㅣ'],
  ['ㅋ', 'ㅌ', 'ㅊ', 'ㅍ', 'ㅠ', 'ㅜ', 'ㅡ']
];

// --- 가상 키보드 생성 ---
function createKeyboard() {
  keyboardDiv.innerHTML = '';
  keyboardRows.forEach(row => {
    const rowDiv = document.createElement('div');
    rowDiv.className = 'keyboard-row';
    row.forEach(letter => {
      const keyDiv = document.createElement('div');
      keyDiv.className = 'key';
      keyDiv.textContent = letter;
      keyDiv.dataset.letter = letter;
      rowDiv.appendChild(keyDiv);
    });
    keyboardDiv.appendChild(rowDiv);
  });
}

function blinkKeysByChar(char) {
  if (!char) return;
  const key = keyboardDiv.querySelector(`.key[data-letter="${char}"]`);
  if (key) {
    key.classList.add('active');
    setTimeout(() => {
      key.classList.remove('active');
    }, 10);
  }
}

// --- 이벤트 리스너 ---
inputField.addEventListener('keydown', (e) => {
  if (!startTime) {
    startTime = new Date();
  }
  if (e.key.length === 1) {
    totalKeystrokes++;
    blinkKeysByChar(e.key);
  }
});


inputField.addEventListener('keyup', (e) => {
  if (e.key === 'Enter' && !processing) {
    processing = true;
    const input = inputField.value.trim();

    if (input === '') {
      processing = false;
      return;
    }

    currentDiv.classList.remove('shake');

    if (input === currentLetter) {
      typedCount++;
      updateRemainingCount();

      if (typedCount >= selectedSentences.length) {
        showModal();
        clearInterval(intervalTimer);
        processing = false;
        return;
      }

      currentLetter = selectedSentences[typedCount];
      nextLetter = selectedSentences[typedCount + 1] || '';

      updateDisplay();
      inputField.value = '';
      inputField.focus();
      processing = false;
    } else {
      accuracyPercent = Math.max(accuracyPercent - 2, 0);
      updateAccuracy();

      setTimeout(() => {
        currentDiv.classList.add('shake');
      }, 20);
      currentDiv.addEventListener('animationend', () => {
        currentDiv.classList.remove('shake');
        processing = false;
      }, { once: true });
    }
  }
});

textSelect.addEventListener('change', () => {
  startCountdown();
});

// --- 업데이트 함수들 ---
function updateTime(diffMs) {
  if (diffMs === 0) {
    timeDisplay.textContent = '시간: 00:00';
    return;
  }
  const totalSeconds = Math.floor(diffMs / 1000);
  const m = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
  const s = String(totalSeconds % 60).padStart(2, '0');
  timeDisplay.textContent = `시간: ${m}:${s}`;
}

function updateTypingSpeed(diffMs) {
  if (diffMs === 0 || totalKeystrokes === 0) {
    typingSpeedDisplay.textContent = '타수: 0';
    speedBar.style.width = '0%';
    return;
  }
  const minutes = diffMs / 60000;
  const speed = Math.floor(totalKeystrokes / minutes);
  typingSpeedDisplay.textContent = `타수: ${speed}`;

  const percent = Math.min((speed / 500) * 100, 100);
  speedBar.style.width = `${percent}%`;
}

function updateRemainingCount() {
  const remaining = selectedSentences.length - typedCount;
  remainingCountDiv.textContent = `남은 문장: ${remaining >= 0 ? remaining : 0}`;
}

function updateAccuracy() {
  accuracyDisplay.textContent = `정확도: ${accuracyPercent}%`;
  accuracyBar.style.width = `${accuracyPercent}%`;
}

function updateDisplay() {
  currentDiv.textContent = currentLetter;
  nextDiv.textContent = nextLetter || '';
  inputField.value = '';
  inputField.focus();
}

// --- 초기화 ---
function initialize() {
  selectedSentences = textData[textSelect.value].slice(0); // 제목 제외
  typedCount = 0;
  totalKeystrokes = 0;
  accuracyPercent = 100;
  startTime = null;

  currentLetter = selectedSentences[typedCount];
  nextLetter = selectedSentences[typedCount + 1] || '';

  updateDisplay();
  updateRemainingCount();
  updateAccuracy();
  updateTime(0);
  updateTypingSpeed(0);

  if (intervalTimer) clearInterval(intervalTimer);
  intervalTimer = setInterval(() => {
    if (!startTime) return;
    const now = new Date();
    const diffMs = now - startTime;
    updateTime(diffMs);
    updateTypingSpeed(diffMs);
  }, 1000);

  inputField.disabled = false;
  modal.classList.add('hidden');
}

// --- 모달 ---
function showModal() {
  modal.classList.remove('hidden');
  const now = new Date();
  const diffMs = now - startTime;
  const totalSeconds = Math.floor(diffMs / 1000);
  const m = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
  const s = String(totalSeconds % 60).padStart(2, '0');
  resultTime.textContent = `걸린 시간: ${m}:${s}`;
  const speed = diffMs > 0 ? Math.floor(totalKeystrokes / (diffMs / 60000)) : 0;
  resultSpeed.textContent = `평균 타수: ${speed}`;
  resultAccuracy.textContent = `정확도: ${accuracyPercent}%`;
  inputField.disabled = true;
}

function hideModal() {
  modal.classList.add('hidden');
}

// --- 카운트다운 ---
function startCountdown() {
  let count = 3;
  countdownDiv.textContent = count;
  countdownDiv.style.display = 'block';
  typingArea.style.display = 'none';
  inputArea.style.display = 'none';
  inputField.disabled = true;

  const countdownInterval = setInterval(() => {
    count--;
    if (count > 0) {
      countdownDiv.textContent = count;
    } else {
      clearInterval(countdownInterval);
      countdownDiv.style.display = 'none';
      typingArea.style.display = 'flex';
      inputArea.style.display = 'block';
      inputField.disabled = false;
      initialize();
    }
  }, 1000);
}

// --- 버튼 ---
backBtn.addEventListener('click', () => {
  window.location.href = 'index.html';
});
modalBackBtn.addEventListener('click', () => {
  window.location.href = 'index.html';
});
modalRetryBtn.addEventListener('click', () => {
  hideModal();
  startCountdown();
});

// --- 실행 ---
createKeyboard();
window.onload = startCountdown;
